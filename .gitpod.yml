image:
  file: Dockerfile

workspaceLocation: canvas/.workspace.json
checkoutLocation: canvas

tasks:
  - init: |
      # Reload the .bash_profile to utilize composer-link()
      source ~/.bash_profile

      cd /workspace

      # Create a new Laravel app
      composer create-project --prefer-dist laravel/laravel laravel

      cd laravel

      # Create a new database
      touch database/database.sqlite
      sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/g' .env
      sed -i 's/DB_DATABASE=laravel/#DB_DATABASE=laravel/g' .env

      # Scaffold user authentication
      composer require laravel/ui
      php artisan ui vue --auth
      yarn && yarn dev

      # Run database migrations
      php artisan migrate

      # Link Canvas to the Laravel app
      composer-link ../canvas/
      composer require cnvs/canvas @dev

      # Install Canvas
      php artisan canvas:install
      php artisan storage:link

      # Remove existing assets from the Laravel app
      rm -rf public/vendor/canvas/*

      # Create a symlink to the package assets
      cd public/vendor/canvas
      ln -s ../../../../canvas/public/* .

      cd /workspace/laravel

      # Trust any proxy in a chain of proxies
      php artisan vendor:publish --provider="Fideloper\Proxy\TrustedProxyServiceProvider"
      sed -Ei "s|'proxies' => null|'proxies' => '**'|g" config/trustedproxy.php

      # Define base app URL
      export url=$(gp url 8000); sed -Ei "s|APP_URL=http://localhost|APP_URL=${url}|g" .env

      # Define asset path
      export url=$(gp url 8000); sed -Ei "1i\ASSET_URL=${url}" .env

      # Define Unsplash access key
      export key=$(gp env); sed -Ei "1i\${key}" .env

      php artisan config:clear
      php artisan cache:clear
      php artisan config:cache
    command:
      php artisan serve

  - init: |
      # install dependencies
      composer install
      yarn
    command: |
      yarn watch
    openMode: split-right

ports:
  - port: 3306
    onOpen: ignore
  - port: 8000
    onOpen: notify
