image:
  file: .gitpod.Dockerfile

tasks:
  - init: |
      # Reload the bash profile to use composer-link()
      source ~/.bash_profile

      cd /workspace

      # Create the Laravel app
      composer create-project --prefer-dist laravel/laravel laravel

      cd laravel

      # Create the database
      touch database/database.sqlite
      sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/g' .env
      sed -i 's/DB_DATABASE=laravel/#DB_DATABASE=laravel/g' .env

      # Set up basic authentication
      composer require laravel/ui
      php artisan ui vue --auth

      # Run the database migrations
      php artisan migrate

      # Link Canvas to the Laravel app
      composer-link ../canvas/
      composer require cnvs/canvas @dev

      # Install Canvas
      php artisan canvas:install
      php artisan storage:link

      # Remove existing assets from the Laravel app
      rm -rf public/vendor/canvas/*

      # Create a symlink to the package assets
      cd public/vendor/canvas
      ln -s ../../../../canvas/public/* .

      cd /workspace/canvas

    command: composer install && yarn && yarn watch
