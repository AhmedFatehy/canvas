image:
  file: Dockerfile

github:
  prebuilds:
    # Enable for the master/default branch (defaults to true)
    master: false
    # Enable for all branches in this repo (defaults to false)
    branches: true
    # Enable for pull requests coming from this repo (defaults to true)
    pullRequests: false
    # Enable for pull requests coming from forks (defaults to false)
    pullRequestsFromForks: false
    # Add a "Review in Gitpod" button as a comment to pull requests (defaults to true)
    addComment: false
    # Add a "Review in Gitpod" button to pull requests (defaults to false)
    addBadge: false
    # Add a label once the prebuild is ready to pull requests (defaults to false)
    addLabel: prebuilt-in-gitpod
    # Register GitPod as a check to pull requests
    addCheck: false

workspaceLocation: canvas/.workspace.json
checkoutLocation: canvas

tasks:
  - before: |
      php -r "file_exists('.env') || copy('.env.example', '.env');"
      export url=$(gp url 8000); sed -Ei "s|APP_URL=http://localhost|APP_URL=${url}|g" .env
      export url=$(gp url 8000); sed -Ei "1i\ASSET_URL=${url}" .env

    init: |
      # Reload the bash profile to use composer-link()
      source ~/.bash_profile

      cd /workspace

      # Create the Laravel app
      composer create-project --prefer-dist laravel/laravel laravel

      cd laravel

      # Create the database
      touch database/database.sqlite
      sed -i 's/DB_CONNECTION=mysql/DB_CONNECTION=sqlite/g' .env
      sed -i 's/DB_DATABASE=laravel/#DB_DATABASE=laravel/g' .env

      # Set up basic authentication
      composer require laravel/ui
      php artisan ui vue --auth
      yarn && yarn dev

      # Run the database migrations
      php artisan migrate

      # Link Canvas to the Laravel app
      composer-link ../canvas/
      composer require cnvs/canvas @dev

      # Install Canvas
      php artisan canvas:install
      php artisan storage:link

      # Remove existing assets from the Laravel app
      rm -rf public/vendor/canvas/*

      # Create a symlink to the package assets
      cd public/vendor/canvas
      ln -s ../../../../canvas/public/* .

      cd /workspace/laravel

      # Trust any proxy in a chain of proxies
      php artisan vendor:publish --provider="Fideloper\Proxy\TrustedProxyServiceProvider"
      sed -Ei "s|'proxies' => null|'proxies' => '**'|g" config/trustedproxy.php

      # Define the app environment URLs
      #export url=$(gp url 8000); sed -Ei "s|APP_URL=http://localhost|APP_URL=${url}|g" .env
      #export url=$(gp url 8000); sed -Ei "1i\ASSET_URL=${url}" .env

      php artisan config:clear
      php artisan cache:clear
      php artisan config:cache
    command:
      php artisan serve

  - init: |
      # install dependencies
      composer install
      yarn
    command: |
      yarn watch
    openMode: split-right

ports:
  - port: 3306
    onOpen: ignore
  - port: 8000
    onOpen: notify
